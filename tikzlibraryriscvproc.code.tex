

\usetikzlibrary{circuits}



%
% Define keys
%
\ctikzset{processor/.is family}
\ctikzset{processor/scale/.initial=1}						% scale of all components
\ctikzset{processor/thickness/.initial=2}					% line width of all components

\ctikzset{processor/memory/height/.initial=2}				% height of memory components
\ctikzset{processor/memory/width/.initial=1.25}				% width of memory components extend unit
\ctikzset{processor/memory/tickwidth/.initial=2}			% width of register file

\ctikzset{processor/control/height/.initial=2.5}				% height of sc control unit
\ctikzset{processor/control/width/.initial=0.9}				% width of sc control unit
\ctikzset{processor/control/radius/.initial=5}				% border radius fo control unit

\ctikzset{processor/arith/height/.initial=0.9}				% height of arith components (e.g. alu/adder)
\ctikzset{processor/arith/width/.initial=0.7}				% width of arith components
\ctikzset{processor/arith/slope/.initial=15}				% slope of arith component sides

\ctikzset{processor/extend/slope/.initial=7}				% slope of extend unit side
\ctikzset{processor/extend/smallheight/.initial=0.6}		% height of right side of extend

\ctikzset{processor/mux/slope/.initial=15}					% slope of mux sides

\ctikzset{processor/misc/smallwidth/.initial=0.3}			% width for small components (e.g. small reg/mux/clk input)
\ctikzset{processor/misc/smallheight/.initial=0.65}			% height for small components (e.g. small reg/2-1-mux)
\ctikzset{processor/misc/leadlen/.initial=.26}				% length of input and output leads (suggested 0.15 * /memory/width)


\ctikzset{processor/mux/inputs/.initial = 2}				% default number of mux inputs
\tikzset{
	inputs/.style args={#1}{circuitikz/processor/mux/inputs=#1}
}


\ctikzset{processor/reg/stacks/.initial = 1}					% default mux height is 1 * smallHeight
\tikzset{
	stacks/.style args={#1}{circuitikz/processor/reg/stacks=#1}
}


\newif\ifpgfcirc@draw@enable@input\pgfcirc@draw@enable@inputfalse
\ctikzset{processor draw enable input/.is choice}
\ctikzset{processor draw enable input/true/.code={\pgfcirc@draw@enable@inputtrue}}
\ctikzset{processor draw enable inputs/false/.code={\pgfcirc@draw@enable@inputfalse}}
\tikzset{enable input/.code={\pgfcirc@draw@enable@inputtrue}}
\tikzset{no enable input/.code={\pgfcirc@draw@enable@inputfalse}}

\newif\ifpgfcirc@draw@input@leads\pgfcirc@draw@input@leadstrue
\ctikzset{processor draw input leads/.is choice}
\ctikzset{processor draw input leads/true/.code={\pgfcirc@draw@input@leadstrue}}
\ctikzset{processor draw input leads/false/.code={\pgfcirc@draw@input@leadsfalse}}
\tikzset{input leads/.code={\pgfcirc@draw@input@leadstrue}}
\tikzset{no input leads/.code={\pgfcirc@draw@input@leadsfalse}}

\newif\ifpgfcirc@draw@output@leads\pgfcirc@draw@output@leadstrue
\ctikzset{processor draw output leads/.is choice}
\ctikzset{processor draw output leads/true/.code={\pgfcirc@draw@output@leadstrue}}
\ctikzset{processor draw output leads/false/.code={\pgfcirc@draw@output@leadsfalse}}
\tikzset{output leads/.code={\pgfcirc@draw@output@leadstrue}}
\tikzset{no output leads/.code={\pgfcirc@draw@output@leadsfalse}}

\ctikzset{processor draw leads/.is choice}
\ctikzset{processor draw leads/true/.code={\pgfcirc@draw@output@leadstrue\pgfcirc@draw@input@leadstrue}}
\ctikzset{processor draw leads/false/.code={\pgfcirc@draw@output@leadsfalse\pgfcirc@draw@input@leadsfalse}}
\tikzset{all leads/.code={\pgfcirc@draw@output@leadstrue\pgfcirc@draw@input@leadstrue}}
\tikzset{no leads/.code={\pgfcirc@draw@output@leadsfalse\pgfcirc@draw@input@leadsfalse}}


%
% Define helpers
%

% Defines generic object anchors. Requires northwest to be a savedanchor
\def\defineorientationanchors{
	\anchor{center}{\pgfpointorigin} % set center to (0,0)
	\anchor{text}{\pgf@x=-.5\wd\pgfnodeparttextbox \pgf@y=-.5\ht\pgfnodeparttextbox} % label text anchor

	\anchor{left}{\northwest \pgf@x=1.3\pgf@x \pgf@y=0pt}
	\anchor{right}{\northwest \pgf@x=-1.3\pgf@x \pgf@y=0pt}
	\anchor{north}{\northwest \pgf@x=0pt}
	\anchor{east}{\northwest \pgf@x=-\pgf@x \pgf@y=0pt}
	\anchor{south}{\northwest \pgf@x=0pt \pgf@y=-\pgf@y}
	\anchor{west}{\northwest \pgf@y=0pt}
	\anchor{north east}{\northwest \pgf@x=-\pgf@x}
	\anchor{north west}{\northwest}
	\anchor{south east}{\northwest \pgf@x=-\pgf@x \pgf@y=-\pgf@y}
	\anchor{south west}{\northwest \pgf@y=-\pgf@y}
}

%
% Define new objects
%

\makeatletter

\pgfdeclareshape{instrmem}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/memory/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{a}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = \pgfmathresult pt
	}

	\anchor{rd}{
		\northwest
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = -\pgfmathresult pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@input@leads
			%input leads
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.5\pgf@circ@res@up}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@up]{A}
		\pgftext[right,x=0.9\pgf@circ@res@right,y=0.5\pgf@circ@res@up]{RD}
		%\pgftext[center,x=0,y=0\pgf@circ@res@up]{\shortstack{Instruction\\Memory}}
	}
}

\pgfdeclareshape{datamem}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/memory/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\clkwidth
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{a}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = \pgfmathresult pt
	}

	\anchor{wd}{
		\northwest
		\pgf@y=-0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = \pgfmathresult pt
	}

	\anchor{clk}{
		\northwest
		\pgfmathparse{\pgf@y + \leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x = 0.5\pgf@x
	}

	\anchor{we}{
		\northwest
		\pgfmathparse{\pgf@y + \leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x = -0.5\pgf@x
	}

	\anchor{rd}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = -\pgfmathresult pt
	}
	
	%
	% b anchors
	%
	
	\anchor{bclk}{
		\northwest
		\pgf@x = 0.5\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		% draw CLK input
		\pgfmathparse{0.5*\clkwidth}
		\pgf@circ@res@step = \pgfmathresult pt
		\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left - \pgf@circ@res@step}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up - \pgf@circ@res@step}}
		\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left + \pgf@circ@res@step}{\pgf@circ@res@up}}
		\pgfpathclose

		\ifpgfcirc@draw@input@leads
			%input leads
			% a
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@up}}

			% wd
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@down}}

			% clk
			\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up + \leadlen}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up}}

			% we
			\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@right}{\pgf@circ@res@up + \leadlen}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@right}{\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% rd
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.5\pgf@circ@res@up}}
		\fi
		\pgfusepath{draw}


		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@up]{A}
		\pgftext[right,x=0.9\pgf@circ@res@right,y=0.5\pgf@circ@res@up]{RD}
		\pgftext[center,x=0.5\pgf@circ@res@right,y=0.85\pgf@circ@res@up]{WE}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@down]{WD}
		%\pgftext[center,x=0,y=0\pgf@circ@res@up]{\shortstack{Data\\Memory}}
	}
}

\pgfdeclareshape{regfile}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/memory/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/tickwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\clkwidth
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{a1}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.6\pgf@y
	}
	\anchor{a2}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0pt
	}
	\anchor{a3}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.3\pgf@y
	}
	\anchor{wd3}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.6\pgf@y
	}

	\anchor{rd1}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.6\pgf@y
	}
	\anchor{rd2}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0pt
	}

	\anchor{clk}{
		\northwest
		\pgfmathparse{\pgf@y+\leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0.5\pgf@x
	}

	\anchor{we3}{
		\northwest
		\pgfmathparse{\pgf@y+\leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0pt
	}
	
	%
	% b anchors
	%
	
	\anchor{bclk}{
		\northwest
		\pgf@x=0.5\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		% draw CLK input
		\pgfmathparse{0.5*\clkwidth}
		\pgf@circ@res@step = \pgfmathresult pt
		\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left - \pgf@circ@res@step}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up - \pgf@circ@res@step}}
		\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left + \pgf@circ@res@step}{\pgf@circ@res@up}}
		\pgfpathclose


		\ifpgfcirc@draw@input@leads

			%input leads
			% a1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{0.6\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.6\pgf@circ@res@up}}

			% a2
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0pt}}

			% a3
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.3\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.3\pgf@circ@res@down}}

			% wd3
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.6\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.6\pgf@circ@res@down}}

			% clk
			\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up +\leadlen}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up}}

			% we3
			\pgfpathmoveto{\pgfpoint{0}{\pgf@circ@res@up + \leadlen}}
			\pgfpathlineto{\pgfpoint{0}{\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% rd1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.6\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.6\pgf@circ@res@up}}

			% rd2
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0pt}}
		\fi
		\pgfusepath{draw}


		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.6\pgf@circ@res@up]{A1}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0pt]{A2}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.3\pgf@circ@res@down]{A3}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.6\pgf@circ@res@down]{WD3}

		\pgftext[right,x=0.9\pgf@circ@res@right,y=0.6\pgf@circ@res@up]{RD1}
		\pgftext[right,x=0.9\pgf@circ@res@right,y=0pt]{RD2}

		\pgftext[center,x=0,y=0.85\pgf@circ@res@up]{WE3}
	}
}

\pgfdeclareshape{reg}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{processor/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgfmathparse{0.5*\pgf@y*\ctikzvalof{\ctikzclass/reg/stacks}}
		\pgf@y=\pgfmathresult pt
		\pgf@x=-\ctikzvalof{processor/misc/smallwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{in}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0 pt
	}

	\anchor{clk}{
		\northwest
		\pgf@x=0 pt
	}

	\anchor{en}{
		\northwest
		\pgf@x=0 pt
		\pgf@y=-\pgf@y
	}

	\anchor{out}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0 pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		% draw clk input
		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfmathparse{\pgf@circ@res@up - \pgf@circ@res@right}
		\pgf@circ@res@step=\pgfmathresult pt
		\pgfpathlineto{\pgfpoint{0pt}{\pgf@circ@res@step}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}

		\ifpgfcirc@draw@input@leads
			%input leads
			% in
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{0}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0}}
		\fi
		\pgfusepath{draw}



		\ifpgfcirc@draw@enable@input
			\pgftext[bottom,x=0pt,y=\pgf@circ@res@down+2pt]{EN}
		\fi
	}
}

\pgfdeclareshape{extend}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgf@y=\ctikzvalof{\ctikzclass/extend/smallheight}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/tickwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\slopeval
	{
		\pgf@x=\ctikzvalof{processor/extend/slope} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\ht\pgfnodeparttextbox+\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgf@x=-.5\wd\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	\anchor{in}{
		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{out}{
		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{-1*\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{ctrl}{
		\northwest
		\pgfmathparse{\pgf@y +\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}
		\pgfmathparse{\pgf@y+2*\pgf@x*tan(\slopeval)}
		\pgf@circ@res@step=\pgfmathresult pt

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@circ@res@step=\pgfmathresult pt

		\ifpgfcirc@draw@input@leads
			%input leads
			% in
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{\pgf@circ@res@step}}
		\fi
		\pgfusepath{draw}

		% no text to draw
	}
}

\long\def\pgfcirc@declare@arith#1#2#3#4{% #1 name, #2 zero signal, #3 ctrl signal, #4 label
	\pgfdeclareshape{#1}{
		%
		% setup
		%

		\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
		\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

		% define northwest as scaled endpoint
		\savedanchor\northwest{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@y=\ctikzvalof{\ctikzclass/arith/height}\pgf@circ@scaled@Rlen
			\pgf@y=.5\pgf@y
			\pgf@x=-\ctikzvalof{\ctikzclass/arith/width}\pgf@circ@scaled@Rlen
			\pgf@x=.5\pgf@x
		}

		\saveddimen\leadlen
		{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
		}

		\saveddimen\slopeval
		{
			\pgf@x=\ctikzvalof{processor/arith/slope} pt
		}

		\saveddimen\cutinheight
		{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgfmathsetmacro\slopeval{\ctikzvalof{processor/arith/slope}}
			\pgfmathparse{0.25*\ctikzvalof{processor/arith/width}*\pgf@circ@scaled@Rlen*tan(\slopeval)}
			\pgf@x=\pgfmathresult pt
		}

		%
		% anchors
		%

		\defineorientationanchors

		\anchor{text}{
			\northwest
			\pgfmathparse{-.5\wd\pgfnodeparttextbox - .25\pgf@x}
			\pgf@x=\pgfmathresult pt
			\pgf@y=-.5\ht\pgfnodeparttextbox
		}

		%
		% pin anchors
		%

		\anchor{a}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=\pgfmathresult pt
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
		}

		\anchor{b}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=-\pgfmathresult pt
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
		}

		\ifnum#3=1
			\anchor{ctrl}{
				\northwest
				\pgfmathparse{\pgf@y + \cutinheight + \leadlen}
				\pgf@y=\pgfmathresult pt
				\pgf@x=0 pt
			}
		\fi

		\anchor{out}{
			\northwest
			\pgfmathparse{-\pgf@x + \leadlen}
			\pgf@x=\pgfmathresult pt
			\pgf@y=0 pt
		}

		\ifnum#2=1
			\anchor{zero}{
				\northwest
				\pgfmathparse{0.5*\pgf@y + \cutinheight}
				\pgf@y=\pgfmathresult pt
				\pgfmathparse{-\pgf@x+\leadlen}
				\pgf@x=\pgfmathresult pt
			}
		\fi

		%
		% b anchors
		%
		
		\anchor{bb}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=-\pgfmathresult pt
		}

		%
		% outline
		%

		\pgf@circ@draw@component{
			\pgf@circ@scaled@Rlen=\scaledRlen
			\pgf@circ@setcolor

			% set up vars
			\northwest
			\pgf@circ@res@up = \pgf@y
			\pgf@circ@res@down = -\pgf@y
			\pgf@circ@res@right = -\pgf@x
			\pgf@circ@res@left = \pgf@x

			% draw shape
			\pgfscope
			\pgf@circ@setlinewidth{processor}{\pgflinewidth}

			\pgfmathparse{2*\pgf@circ@res@right*tan(\slopeval)}
			\pgf@circ@res@step=\pgfmathresult pt

			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\cutinheight}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up + \pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down-\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\cutinheight}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{0pt}}
			\pgfpathclose

			\pgf@circ@draworfill
			\endpgfscope

			\ifpgfcirc@draw@input@leads
				%input leads
				% a
				\pgfmathparse{0.75*\pgf@circ@res@up + \cutinheight}
				\pgf@circ@res@step=\pgfmathresult pt
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}

				% b
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-\pgf@circ@res@step}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\pgf@circ@res@step}}

				\ifnum#3=1
					% ctrl
					\pgfmathparse{\pgf@circ@res@up+ 2*\cutinheight + \leadlen}
					\pgf@circ@res@step=\pgfmathresult pt
					\pgfpathmoveto{\pgfpoint{0pt}{\pgf@circ@res@step}}
					\pgfmathparse{\pgf@circ@res@up+ 2*\cutinheight}
					\pgf@circ@res@step=\pgfmathresult pt
					\pgfpathlineto{\pgfpoint{0pt}{\pgf@circ@res@step}}
				\fi
			\fi

			\ifpgfcirc@draw@output@leads
				%output leads
				% out
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}

				\ifnum#2=1
					% zero
					\pgfmathparse{0.5*\pgf@circ@res@up + \cutinheight}
					\pgf@circ@res@step=\pgfmathresult pt
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right + \leadlen}{\pgf@circ@res@step}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@step}}
				\fi
			\fi
			\pgfusepath{draw}

			%draw text
			\pgf@circ@text@strokecolor
			\pgftext[center,x=0.25\pgf@circ@res@right,y=0pt]{\textbf{#4}}
		}
	}

}

\pgfcirc@declare@arith{alu}{1}{1}{}
\pgfcirc@declare@arith{adder}{0}{0}{+}
\pgfcirc@declare@arith{sub}{0}{0}{-}

%\long\def\pgfcirc@declare@dynmux#1#2#3#4{% #1 name, #2 zero signal, #3 ctrl signal, #4 label

\pgfdeclareshape{mux}{
	%
	% setup
	%

	% TODO: Adjustable mux height

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=-\ctikzvalof{processor/misc/smallwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x
		\pgf@y=\ctikzvalof{processor/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		%\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))*0.5*\ctikzvalof{processor/mux/inputs}}
		\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))}
		\pgf@y=\pgfmathresult pt
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\slopeval
	{
		\pgf@x=\ctikzvalof{processor/mux/slope} pt
	}

	\saveddimen\cutinheight
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		\pgfmathparse{\ctikzvalof{processor/misc/smallwidth}*\pgf@circ@scaled@Rlen*tan(\slopeval)}
		\pgf@x=\pgfmathresult pt
	}

	\saveddimen\inputs
	{
		\pgf@x=\ctikzvalof{processor/mux/inputs} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\wd\pgfnodeparttextbox - .25\pgf@x}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-.5\ht\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	%\foreach \i in {1,...,\pgfcirc@draw@input@leads} {
	%	\pgfmathparse{\i-1}
	%	\pgf@temp = \pgfmathresult
	%	\expandafter\anchor\expandafter{\csname in\i\endcsname}{
	%		\northwest
	%	}
	%}

	\anchor{in0}{
		\northwest
		\pgfmathparse{0.5*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in1}{
		\northwest
		\pgfmathparse{0.5*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{sel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{out}{
		\northwest
		\pgf@y=0pt
		\pgfmathparse{-\pgf@x + \leadlen}
		\pgf@x=\pgfmathresult pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down - \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up + \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@input@leads
			%input leads
			% in0
			\pgfmathparse{0.5*(\pgf@circ@res@up + \cutinheight)}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}

			% in1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\pgf@circ@res@step}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[center,x=0pt,y=0.5\pgf@circ@res@up]{0}
		\pgftext[center,x=0pt,y=0.5\pgf@circ@res@down]{1}
	}
}

\pgfdeclareshape{ctrlunitsc}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/control/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/control/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\radius
	{
		\pgf@x=\ctikzvalof{\ctikzclass/control/radius} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgf@x=-.5\wd\pgfnodeparttextbox
		\pgfmathparse{-.5\pgf@y+.5\ht\pgfnodeparttextbox}
		\pgf@y=-\pgfmathresult pt
	}

	%
	% pin anchors
	%

	\anchor{op}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0pt
	}
	\anchor{funct3}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.25\pgf@y
	}
	\anchor{funct7}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.5\pgf@y
	}
	\anchor{zero}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.75\pgf@y
	}



	\anchor{pcsrc}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.75\pgf@y
	}
	\anchor{resultsrc}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.5\pgf@y
	}
	\anchor{memwrite}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.25\pgf@y
	}
	\anchor{alucontrol}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0 pt
	}
	\anchor{alusrc}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.25\pgf@y
	}
	\anchor{immsrc}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.5\pgf@y
	}
	\anchor{regwrite}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.75\pgf@y
	}


	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}
		\pgfsetcornersarced{\pgfpoint{\radius}{\radius}}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope



		\ifpgfcirc@draw@input@leads
			%input leads
			% op
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0pt}}
			% funct3
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.25\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.25\pgf@circ@res@down}}
			% funct7
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@down}}
			% zero
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.75\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.75\pgf@circ@res@down}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% pcsrc
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.75\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.75\pgf@circ@res@up}}
			% resultsrc
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.5\pgf@circ@res@up}}
			% memwrite
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.25\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.25\pgf@circ@res@up}}
			% alucontrol
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0pt}}
			% alusrc
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.25\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.25\pgf@circ@res@down}}
			% immsrc
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.5\pgf@circ@res@down}}
			% regwrite
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.75\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.75\pgf@circ@res@down}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0pt]{op}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.25\pgf@circ@res@down]{funct3}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@down]{funct7\textsubscript{5}}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.75\pgf@circ@res@down]{zero}
	}
}


\makeatother

\endinput
