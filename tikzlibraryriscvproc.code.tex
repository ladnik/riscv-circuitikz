
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                  riscvproc                                   %
%                A RISC-V Processor Components CircuiTikZ Library              %
%            Copyright (C) 2025 Niklas Ladurner - All Rights Reserved          %
%                                                                              %
%            You may use, distribute and modify this code under the            %
%                   terms of the GNU General Public License.                   %
%                                                                              %
%           You should have received a copy of the GNU General Public          %
%                 License  with this file. If not, please visit                %
%                      www.gnu.org/licenses/gpl-3.0.html                       %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
% Define keys
%
\ctikzset{processor/.is family}
\ctikzset{processor/scale/.initial=1}						% scale of all components
\ctikzset{processor/thickness/.initial=2}					% line width of all components
\def\customfont{\rmfamily}
\ctikzset{processor/font/.store in=\customfont}				% set font for component labels

% TODO: line thickness for leads


\ctikzset{processor/memory/height/.initial=2}				% height of memory components
\ctikzset{processor/memory/width/.initial=1.25}				% width of memory components extend unit
\ctikzset{processor/memory/tickwidth/.initial=2}			% width of register file

\ctikzset{processor/control/heightsc/.initial=2.5}			% height of sc control unit
\ctikzset{processor/control/heightmc/.initial=3.5}			% height of mc control unit
\ctikzset{processor/control/width/.initial=0.9}				% width of control units
\ctikzset{processor/control/radius/.initial=5}				% border radius for control units

\ctikzset{processor/arith/height/.initial=0.9}				% height of arith components
\ctikzset{processor/arith/width/.initial=0.7}				% width of arith components
\ctikzset{processor/arith/slope/.initial=15}				% slope of arith component sides

\ctikzset{processor/extend/height/.initial=0.6}				% height of right side of extend
\ctikzset{processor/extend/width/.initial=2}				% width of extend
\ctikzset{processor/extend/slope/.initial=7}				% slope of extend unit side

\ctikzset{processor/mux/slope/.initial=15}					% slope of mux sides

\ctikzset{processor/misc/smallheight/.initial=0.65}			% height for small components
\ctikzset{processor/misc/smallwidth/.initial=0.3}			% width for small components (e.g. small reg/mux/clk input)
\ctikzset{processor/misc/leadlen/.initial=.25}				% length of input and output leads (suggested ~ 0.15 * /memory/width)

\ctikzset{processor/hazard/height/.initial=0.9}				% height of hazard unit
\ctikzset{processor/hazard/width/.initial=19}				% width of hazard unit
\ctikzset{processor/hazard/radius/.initial=5}				% border radius for hazard unit


\ctikzset{processor/mux/inputs/.initial = 2}				% default number of mux inputs
\tikzset{
	inputs/.style args={#1}{circuitikz/processor/mux/inputs=#1}
}


\ctikzset{processor/reg/stacks/.initial = 1}				% default mux height is smallHeight
\tikzset{
	stacks/.style args={#1}{circuitikz/processor/reg/stacks=#1}
}


\newif\ifpgfcirc@draw@enable@input\pgfcirc@draw@enable@inputfalse
\ctikzset{processor draw enable input/.is choice}
\ctikzset{processor draw enable input/true/.code={\pgfcirc@draw@enable@inputtrue}}
\ctikzset{processor draw enable input/false/.code={\pgfcirc@draw@enable@inputfalse}}
\tikzset{enable input/.code={\pgfcirc@draw@enable@inputtrue}}
\tikzset{no enable input/.code={\pgfcirc@draw@enable@inputfalse}}

\newif\ifpgfcirc@draw@clear@input\pgfcirc@draw@clear@inputfalse
\ctikzset{processor draw clear input/.is choice}
\ctikzset{processor draw clear input/true/.code={\pgfcirc@draw@clear@inputtrue}}
\ctikzset{processor draw clear input/false/.code={\pgfcirc@draw@clear@inputfalse}}
\tikzset{clear input/.code={\pgfcirc@draw@clear@inputtrue}}
\tikzset{no clear input/.code={\pgfcirc@draw@clear@inputfalse}}

\newif\ifpgfcirc@draw@clock\pgfcirc@draw@clocktrue
\ctikzset{processor draw clock/.is choice}
\ctikzset{processor draw clock/true/.code={\pgfcirc@draw@clocktrue}}
\ctikzset{processor draw clock/false/.code={\pgfcirc@draw@clockfalse}}
\tikzset{clock/.code={\pgfcirc@draw@clocktrue}}
\tikzset{no clock/.code={\pgfcirc@draw@clockfalse}}

\newif\ifpgfcirc@draw@input@leads\pgfcirc@draw@input@leadstrue
\ctikzset{processor draw input leads/.is choice}
\ctikzset{processor draw input leads/true/.code={\pgfcirc@draw@input@leadstrue}}
\ctikzset{processor draw input leads/false/.code={\pgfcirc@draw@input@leadsfalse}}
\tikzset{input leads/.code={\pgfcirc@draw@input@leadstrue}}
\tikzset{no input leads/.code={\pgfcirc@draw@input@leadsfalse}}

\newif\ifpgfcirc@draw@output@leads\pgfcirc@draw@output@leadstrue
\ctikzset{processor draw output leads/.is choice}
\ctikzset{processor draw output leads/true/.code={\pgfcirc@draw@output@leadstrue}}
\ctikzset{processor draw output leads/false/.code={\pgfcirc@draw@output@leadsfalse}}
\tikzset{output leads/.code={\pgfcirc@draw@output@leadstrue}}
\tikzset{no output leads/.code={\pgfcirc@draw@output@leadsfalse}}

\ctikzset{processor draw leads/.is choice}
\ctikzset{processor draw leads/true/.code={\pgfcirc@draw@output@leadstrue\pgfcirc@draw@input@leadstrue}}
\ctikzset{processor draw leads/false/.code={\pgfcirc@draw@output@leadsfalse\pgfcirc@draw@input@leadsfalse}}
\tikzset{all leads/.code={\pgfcirc@draw@output@leadstrue\pgfcirc@draw@input@leadstrue}}
\tikzset{no leads/.code={\pgfcirc@draw@output@leadsfalse\pgfcirc@draw@input@leadsfalse}}


%
% Define helpers
%

% Defines generic object anchors. Requires northwest to be a savedanchor
\def\defineorientationanchors{
	\anchor{center}{\pgfpointorigin} % set center to (0,0)
	\anchor{text}{\pgf@x=-.5\wd\pgfnodeparttextbox \pgf@y=-.5\ht\pgfnodeparttextbox} % label text anchor

	\anchor{left}{\northwest \pgf@x=1.3\pgf@x \pgf@y=0pt}
	\anchor{right}{\northwest \pgf@x=-1.3\pgf@x \pgf@y=0pt}
	\anchor{north}{\northwest \pgf@x=0pt}
	\anchor{east}{\northwest \pgf@x=-\pgf@x \pgf@y=0pt}
	\anchor{south}{\northwest \pgf@x=0pt \pgf@y=-\pgf@y}
	\anchor{west}{\northwest \pgf@y=0pt}
	\anchor{north east}{\northwest \pgf@x=-\pgf@x}
	\anchor{north west}{\northwest}
	\anchor{south east}{\northwest \pgf@x=-\pgf@x \pgf@y=-\pgf@y}
	\anchor{south west}{\northwest \pgf@y=-\pgf@y}
}

%
% Define new objects
%

\makeatletter

\pgfdeclareshape{instrmem}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/memory/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{a}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = \pgfmathresult pt
	}

	\anchor{rd}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = -\pgfmathresult pt
	}

	%
	% b anchors
	%

	\anchor{ba}{
		\northwest
		\pgf@y=0.5\pgf@y
	}

	\anchor{brd}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgf@x=-\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@input@leads
			%input leads
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.5\pgf@circ@res@up}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@up]{\customfont A}
		\pgftext[right,x=0.9\pgf@circ@res@right,y=0.5\pgf@circ@res@up]{\customfont RD}
		%\pgftext[center,x=0,y=0\pgf@circ@res@up]{\shortstack{Instruction\\Memory}}
	}
}

\pgfdeclareshape{datamem}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/memory/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\clkwidth
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{a}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = \pgfmathresult pt
	}

	\anchor{wd}{
		\northwest
		\pgf@y=-0.6\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = \pgfmathresult pt
	}

	\anchor{clk}{
		\northwest
		\pgfmathparse{\pgf@y + \leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x = 0.5\pgf@x
	}

	\anchor{we}{
		\northwest
		\pgfmathparse{\pgf@y + \leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x = -0.5\pgf@x
	}

	\anchor{rd}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgfmathparse{\pgf@x - \leadlen}
		\pgf@x = -\pgfmathresult pt
	}

	%
	% b anchors
	%

	\anchor{ba}{
		\northwest
		\pgf@y=0.5\pgf@y
	}

	\anchor{bwd}{
		\northwest
		\pgf@y=-0.6\pgf@y
	}

	\anchor{bclk}{
		\northwest
		\pgf@x = 0.5\pgf@x
	}

	\anchor{bwe}{
		\northwest
		\pgf@x = -0.5\pgf@x
	}

	\anchor{brd}{
		\northwest
		\pgf@y=0.5\pgf@y
		\pgf@x = -\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@clock
			% draw CLK input
			\pgfmathparse{0.5*\clkwidth}
			\pgf@circ@res@step = \pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left - \pgf@circ@res@step}{\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up - \pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left + \pgf@circ@res@step}{\pgf@circ@res@up}}
			\pgfpathclose
		\fi

		\ifpgfcirc@draw@input@leads
			%input leads
			% a
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@up}}

			% wd
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.6\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.6\pgf@circ@res@down}}

			\ifpgfcirc@draw@clock
				% clk
				\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up + \leadlen}}
				\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up}}
			\fi

			% we
			\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@right}{\pgf@circ@res@up + \leadlen}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@right}{\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% rd
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.5\pgf@circ@res@up}}
		\fi
		\pgfusepath{draw}


		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@up]{\customfont A}
		\pgftext[right,x=0.9\pgf@circ@res@right,y=0.5\pgf@circ@res@up]{\customfont RD}
		\pgftext[center,x=0.5\pgf@circ@res@right,y=0.85\pgf@circ@res@up]{\customfont WE}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.6\pgf@circ@res@down]{\customfont WD}
		%\pgftext[center,x=0,y=0\pgf@circ@res@up]{\shortstack{Data\\Memory}}
	}
}

\pgfdeclareshape{regfile}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/memory/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/memory/tickwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\clkwidth
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\ht\pgfnodeparttextbox+0.25*\pgf@y}
		\pgf@y = \pgfmathresult pt
		\pgf@x= -.5\wd\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	\anchor{a1}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.6\pgf@y
	}
	\anchor{a2}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0pt
	}
	\anchor{a3}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.3\pgf@y
	}
	\anchor{wd3}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-0.6\pgf@y
	}

	\anchor{rd1}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0.6\pgf@y
	}
	\anchor{rd2}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgf@y=0pt
	}

	\anchor{clk}{
		\northwest
		\pgfmathparse{\pgf@y+\leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0.5\pgf@x
	}

	\anchor{we3}{
		\northwest
		\pgfmathparse{\pgf@y+\leadlen}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0pt
	}

	%
	% b anchors
	%

	\anchor{ba1}{
		\northwest
		\pgf@y=0.6\pgf@y
	}
	\anchor{ba2}{
		\northwest
		\pgf@y=0pt
	}
	\anchor{ba3}{
		\northwest
		\pgf@y=-0.3\pgf@y
	}
	\anchor{bwd3}{
		\northwest
		\pgf@y=-0.6\pgf@y
	}

	\anchor{brd1}{
		\northwest
		\pgf@x=-\pgf@x
		\pgf@y=0.6\pgf@y
	}
	\anchor{brd2}{
		\northwest
		\pgf@x=-\pgf@x
		\pgf@y=0pt
	}

	\anchor{bclk}{
		\northwest
		\pgf@x=0.5\pgf@x
	}

	\anchor{bwe3}{
		\northwest
		\pgf@x=0pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope


		\ifpgfcirc@draw@clock
			% draw CLK input
			\pgfmathparse{0.5*\clkwidth}
			\pgf@circ@res@step = \pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left - \pgf@circ@res@step}{\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up - \pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left + \pgf@circ@res@step}{\pgf@circ@res@up}}
			\pgfpathclose
		\fi


		\ifpgfcirc@draw@input@leads

			%input leads
			% a1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{0.6\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.6\pgf@circ@res@up}}

			% a2
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0pt}}

			% a3
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.3\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.3\pgf@circ@res@down}}

			% wd3
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.6\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.6\pgf@circ@res@down}}

			\ifpgfcirc@draw@clock
				% clk
				\pgfpathmoveto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up +\leadlen}}
				\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{\pgf@circ@res@up}}
			\fi

			% we3
			\pgfpathmoveto{\pgfpoint{0}{\pgf@circ@res@up + \leadlen}}
			\pgfpathlineto{\pgfpoint{0}{\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% rd1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.6\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0.6\pgf@circ@res@up}}

			% rd2
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{0pt}}
		\fi
		\pgfusepath{draw}


		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.6\pgf@circ@res@up]{\customfont A1}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0pt]{\customfont A2}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.3\pgf@circ@res@down]{\customfont A3}
		\pgftext[left,x=0.9\pgf@circ@res@left,y=0.6\pgf@circ@res@down]{\customfont WD3}

		\pgftext[right,x=0.9\pgf@circ@res@right,y=0.6\pgf@circ@res@up]{\customfont RD1}
		\pgftext[right,x=0.9\pgf@circ@res@right,y=0pt]{\customfont RD2}

		\pgftext[center,x=0,y=0.85\pgf@circ@res@up]{\customfont WE3}
	}
}

\pgfdeclareshape{reg}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgfmathparse{0.5*\pgf@y*\ctikzvalof{\ctikzclass/reg/stacks}}
		\pgf@y=\pgfmathresult pt
		\pgf@x=-\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\stackheight
	{
		\pgf@x=\ctikzvalof{\ctikzclass/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgf@x=0.5\pgf@x
	}


	%
	% anchors
	%

	\defineorientationanchors

	%
	% pin anchors
	%

	\anchor{in}{
		\northwest
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgfmathparse{\pgf@y-\stackheight}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{clk}{
		\northwest
		\pgf@x=0 pt
	}

	\anchor{en}{
		\northwest
		\pgf@x=0 pt
		\pgf@y=-\pgf@y
	}

	\anchor{enl}{
		\northwest
		\pgf@x=0.5\pgf@x
		\pgf@y=-\pgf@y
	}

	\anchor{clr}{
		\northwest
		\pgf@x=-0.5\pgf@x
		\pgf@y=-\pgf@y
	}

	\anchor{out}{
		\northwest
		\pgfmathparse{-\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
		\pgfmathparse{\pgf@y-\stackheight}
		\pgf@y=\pgfmathresult pt
	}

	%
	% b anchors
	%

	\anchor{bin}{
		\northwest
		\pgfmathparse{\pgf@y-\stackheight}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{bclk}{
		\northwest
		\pgf@x=0 pt
	}

	\anchor{ben}{
		\northwest
		\pgf@x=0 pt
		\pgf@y=-\pgf@y
	}

	\anchor{benl}{
		\northwest
		\pgf@x=0.5\pgf@x
		\pgf@y=-\pgf@y
	}

	\anchor{bclr}{
		\northwest
		\pgf@x=-0.5\pgf@x
		\pgf@y=-\pgf@y
	}

	\anchor{bout}{
		\northwest
		\pgf@x=-\pgf@x
		\pgfmathparse{\pgf@y-\stackheight}
		\pgf@y=\pgfmathresult pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@clock
			% draw clk input
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
			\pgfmathparse{\pgf@circ@res@up - \pgf@circ@res@right}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathlineto{\pgfpoint{0pt}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\fi

		\ifpgfcirc@draw@input@leads
			%input leads
			% in
			\northwest
			\pgfmathparse{\pgf@y-\stackheight}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\northwest
			\pgfmathparse{\pgf@y-\stackheight}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{\pgf@circ@res@step}}
		\fi
		\pgfusepath{draw}



		\ifpgfcirc@draw@enable@input
			\ifpgfcirc@draw@clear@input
				\pgftext[bottom,x=0pt,y=\pgf@circ@res@down+5pt, rotate=90]{\customfont \scriptsize EN}
			\else
				\pgftext[bottom,x=0pt,y=\pgf@circ@res@down+2pt]{\customfont \scriptsize EN}
			\fi
		\fi

		\ifpgfcirc@draw@clear@input
			\pgftext[bottom,x=5pt,y=\pgf@circ@res@down+7.25pt, rotate=90]{\customfont \scriptsize CLR}
		\fi
	}
}

\pgfdeclareshape{extend}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgf@y=\ctikzvalof{\ctikzclass/extend/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y
		\pgf@x=-\ctikzvalof{\ctikzclass/extend/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\slopeval
	{
		\pgf@x=\ctikzvalof{processor/extend/slope} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\ht\pgfnodeparttextbox+\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgf@x=-.5\wd\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	\anchor{in}{
		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{out}{
		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{-1*\pgf@x+\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{ctrl}{
		\northwest
		\pgfmathparse{\pgf@y +\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	%
	% b anchors
	%

	\anchor{bin}{
		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{bout}{
		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgf@x=-\pgf@x
	}

	\anchor{bctrl}{
		\northwest
		\pgfmathparse{\pgf@y +\pgf@x*tan(\slopeval)}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}
		\pgfmathparse{\pgf@y+2*\pgf@x*tan(\slopeval)}
		\pgf@circ@res@step=\pgfmathresult pt

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\northwest
		\pgfmathparse{\pgf@x*tan(\slopeval)}
		\pgf@circ@res@step=\pgfmathresult pt

		\ifpgfcirc@draw@input@leads
			%input leads
			% in
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right-\pgf@circ@res@other}{\pgf@circ@res@step}}
		\fi
		\pgfusepath{draw}

		% no text to draw
	}
}

\long\def\pgfcirc@declare@arith#1#2#3#4{% #1 name, #2 zero signal, #3 ctrl signal, #4 label
	\pgfdeclareshape{#1}{
		%
		% setup
		%

		\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
		\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

		% define northwest as scaled endpoint
		\savedanchor\northwest{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@y=\ctikzvalof{\ctikzclass/arith/height}\pgf@circ@scaled@Rlen
			\pgf@y=.5\pgf@y
			\pgf@x=-\ctikzvalof{\ctikzclass/arith/width}\pgf@circ@scaled@Rlen
			\pgf@x=.5\pgf@x
		}

		\saveddimen\leadlen
		{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
		}

		\saveddimen\slopeval
		{
			\pgf@x=\ctikzvalof{processor/arith/slope} pt
		}

		\saveddimen\cutinheight
		{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgfmathsetmacro\slopeval{\ctikzvalof{processor/arith/slope}}
			\pgfmathparse{0.25*\ctikzvalof{processor/arith/width}*\pgf@circ@scaled@Rlen*tan(\slopeval)}
			\pgf@x=\pgfmathresult pt
		}

		%
		% anchors
		%

		\defineorientationanchors

		\anchor{text}{
			\northwest
			\pgfmathparse{-.5\wd\pgfnodeparttextbox - .25\pgf@x}
			\pgf@x=\pgfmathresult pt
			\pgf@y=-.5\ht\pgfnodeparttextbox
		}

		%
		% pin anchors
		%

		\anchor{a}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=\pgfmathresult pt
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
		}

		\anchor{b}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=-\pgfmathresult pt
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
		}

		\ifnum#3=1
			\anchor{ctrl}{
				\northwest
				\pgfmathparse{\pgf@y + 2*\cutinheight + \leadlen}
				\pgf@y=\pgfmathresult pt
				\pgf@x=0 pt
			}
		\fi

		\anchor{out}{
			\northwest
			\pgfmathparse{-\pgf@x + \leadlen}
			\pgf@x=\pgfmathresult pt
			\pgf@y=0 pt
		}

		\ifnum#2=1
			\anchor{zero}{
				\northwest
				\pgfmathparse{0.5*\pgf@y + \cutinheight}
				\pgf@y=\pgfmathresult pt
				\pgfmathparse{-\pgf@x+\leadlen}
				\pgf@x=\pgfmathresult pt
			}
		\fi

		%
		% b anchors
		%

		\anchor{ba}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=\pgfmathresult pt
		}

		\anchor{bb}{
			\northwest
			\pgfmathparse{0.75*\pgf@y + \cutinheight}
			\pgf@y=-\pgfmathresult pt
		}

		\ifnum#3=1
			\anchor{bctrl}{
				\northwest
				\pgfmathparse{\pgf@y + 2*\cutinheight}
				\pgf@y=\pgfmathresult pt
				\pgf@x=0 pt
			}
		\fi

		\anchor{bout}{
			\northwest
			\pgf@x=-\pgf@x
			\pgf@y=0 pt
		}

		\ifnum#2=1
			\anchor{bzero}{
				\northwest
				\pgfmathparse{0.5*\pgf@y + \cutinheight}
				\pgf@y=\pgfmathresult pt
				\pgf@x=-\pgf@x
			}
		\fi

		%
		% outline
		%

		\pgf@circ@draw@component{
			\pgf@circ@scaled@Rlen=\scaledRlen
			\pgf@circ@setcolor

			% set up vars
			\northwest
			\pgf@circ@res@up = \pgf@y
			\pgf@circ@res@down = -\pgf@y
			\pgf@circ@res@right = -\pgf@x
			\pgf@circ@res@left = \pgf@x

			% draw shape
			\pgfscope
			\pgf@circ@setlinewidth{processor}{\pgflinewidth}

			\pgfmathparse{2*\pgf@circ@res@right*tan(\slopeval)}
			\pgf@circ@res@step=\pgfmathresult pt

			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\cutinheight}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up + \pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down-\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\cutinheight}}
			\pgfpathlineto{\pgfpoint{0.5\pgf@circ@res@left}{0pt}}
			\pgfpathclose

			\pgf@circ@draworfill
			\endpgfscope

			\ifpgfcirc@draw@input@leads
				%input leads
				% a
				\pgfmathparse{0.75*\pgf@circ@res@up + \cutinheight}
				\pgf@circ@res@step=\pgfmathresult pt
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}

				% b
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-\pgf@circ@res@step}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\pgf@circ@res@step}}

				\ifnum#3=1
					% ctrl
					\pgfmathparse{\pgf@circ@res@up+ 2*\cutinheight + \leadlen}
					\pgf@circ@res@step=\pgfmathresult pt
					\pgfpathmoveto{\pgfpoint{0pt}{\pgf@circ@res@step}}
					\pgfmathparse{\pgf@circ@res@up+ 2*\cutinheight}
					\pgf@circ@res@step=\pgfmathresult pt
					\pgfpathlineto{\pgfpoint{0pt}{\pgf@circ@res@step}}
				\fi
			\fi

			\ifpgfcirc@draw@output@leads
				%output leads
				% out
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}

				\ifnum#2=1
					% zero
					\pgfmathparse{0.5*\pgf@circ@res@up + \cutinheight}
					\pgf@circ@res@step=\pgfmathresult pt
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right + \leadlen}{\pgf@circ@res@step}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@step}}
				\fi
			\fi
			\pgfusepath{draw}

			%draw text
			\pgf@circ@text@strokecolor
			\pgftext[center,x=0.25\pgf@circ@res@right,y=0pt]{\customfont #4}
		}
	}

}

\pgfcirc@declare@arith{alu}{1}{1}{ALU}
\pgfcirc@declare@arith{adder}{0}{0}{\textbf{+}}
\pgfcirc@declare@arith{subtr}{0}{0}{\textbf{-}}

% TODO: dynamic number of mux inputs

\pgfdeclareshape{mux}{
	%
	% setup
	%

	% TODO: Adjustable mux height

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=-\ctikzvalof{processor/misc/smallwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x
		\pgf@y=\ctikzvalof{processor/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		%\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))*0.5*\ctikzvalof{processor/mux/inputs}}
		\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))}
		\pgf@y=\pgfmathresult pt
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\slopeval
	{
		\pgf@x=\ctikzvalof{processor/mux/slope} pt
	}

	\saveddimen\cutinheight
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		\pgfmathparse{\ctikzvalof{processor/misc/smallwidth}*\pgf@circ@scaled@Rlen*tan(\slopeval)}
		\pgf@x=\pgfmathresult pt
	}

	\saveddimen\inputs
	{
		\pgf@x=\ctikzvalof{processor/mux/inputs} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\wd\pgfnodeparttextbox - .25\pgf@x}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-.5\ht\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	%\foreach \i in {1,...,\pgfcirc@draw@input@leads} {
	%	\pgfmathparse{\i-1}
	%	\pgf@temp = \pgfmathresult
	%	\expandafter\anchor\expandafter{\csname in\i\endcsname}{
	%		\northwest
	%	}
	%}

	\anchor{in0}{
		\northwest
		\pgfmathparse{0.5*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in1}{
		\northwest
		\pgfmathparse{0.5*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{sel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{fwd}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=-\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{out}{
		\northwest
		\pgf@y=0pt
		\pgfmathparse{-\pgf@x + \leadlen}
		\pgf@x=\pgfmathresult pt
	}

	%
	% b anchors
	%

	\anchor{bin0}{
		\northwest
		\pgfmathparse{0.5*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{bin1}{
		\northwest
		\pgfmathparse{0.5*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
	}

	\anchor{bsel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{bfwd}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=-\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{bout}{
		\northwest
		\pgf@y=0pt
		\pgf@x=-\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down - \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up + \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@input@leads
			%input leads
			% in0
			\pgfmathparse{0.5*(\pgf@circ@res@up + \cutinheight)}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}

			% in1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\pgf@circ@res@step}}
		\fi

		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[center,x=0pt,y=0.5\pgf@circ@res@up]{\customfont 0}
		\pgftext[center,x=0pt,y=0.5\pgf@circ@res@down]{\customfont 1}
	}
}

\pgfdeclareshape{3mux}{
	%
	% setup
	%

	% TODO: Adjustable mux height

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=-\ctikzvalof{processor/misc/smallwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.75\pgf@x
		\pgf@y=\ctikzvalof{processor/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		%\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))*0.5*\ctikzvalof{processor/mux/inputs}}
		\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))*2}
		\pgf@y=\pgfmathresult pt
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\slopeval
	{
		\pgf@x=\ctikzvalof{processor/mux/slope} pt
	}

	\saveddimen\cutinheight
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		\pgfmathparse{1.5*\ctikzvalof{processor/misc/smallwidth}*\pgf@circ@scaled@Rlen*tan(\slopeval)}
		\pgf@x=\pgfmathresult pt
	}

	\saveddimen\inputs
	{
		\pgf@x=\ctikzvalof{processor/mux/inputs} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\wd\pgfnodeparttextbox - .25\pgf@x}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-.5\ht\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	\anchor{in0}{
		\northwest
		\pgfmathparse{0.6*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in1}{
		\northwest
		\pgf@y=0 pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in2}{
		\northwest
		\pgfmathparse{0.6*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{sel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{fwd}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=-\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{out}{
		\northwest
		\pgf@y=0pt
		\pgfmathparse{-\pgf@x + \leadlen}
		\pgf@x=\pgfmathresult pt
	}

	%
	% b anchors
	%

	\anchor{bin0}{
		\northwest
		\pgfmathparse{0.6*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{bin1}{
		\northwest
		\pgf@y=0 pt
	}

	\anchor{bin2}{
		\northwest
		\pgfmathparse{0.6*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
	}

	\anchor{bsel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{bfwd}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=-\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{bout}{
		\northwest
		\pgf@y=0pt
		\pgf@x=-\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down - \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up + \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@input@leads
			%input leads
			% in0
			\pgfmathparse{0.6*(\pgf@circ@res@up + \cutinheight)}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}

			% in1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0pt}}

			% in2
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\pgf@circ@res@step}}
		\fi


		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[center,x=0pt,y=0.6\pgf@circ@res@up]{\customfont 00}
		\pgftext[center,x=0pt,y=0pt]{\customfont 01}
		\pgftext[center,x=0pt,y=0.6\pgf@circ@res@down]{\customfont 10}
	}
}

\pgfdeclareshape{4mux}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=-\ctikzvalof{processor/misc/smallwidth}\pgf@circ@scaled@Rlen
		\pgf@x=.75\pgf@x
		\pgf@y=\ctikzvalof{processor/misc/smallheight}\pgf@circ@scaled@Rlen
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		\pgfmathparse{(.5*\pgf@y+2*\pgf@x*tan(\slopeval))*2.5}
		\pgf@y=\pgfmathresult pt
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\slopeval
	{
		\pgf@x=\ctikzvalof{processor/mux/slope} pt
	}

	\saveddimen\cutinheight
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgfmathsetmacro\slopeval{\ctikzvalof{processor/mux/slope}}
		\pgfmathparse{1.5*\ctikzvalof{processor/misc/smallwidth}*\pgf@circ@scaled@Rlen*tan(\slopeval)}
		\pgf@x=\pgfmathresult pt
	}

	\saveddimen\inputs
	{
		\pgf@x=\ctikzvalof{processor/mux/inputs} pt
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\northwest
		\pgfmathparse{-.5\wd\pgfnodeparttextbox - .25\pgf@x}
		\pgf@x=\pgfmathresult pt
		\pgf@y=-.5\ht\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	\anchor{in0}{
		\northwest
		\pgfmathparse{0.75*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in1}{
		\northwest
		\pgfmathparse{0.25*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in2}{
		\northwest
		\pgfmathparse{0.25*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{in3}{
		\northwest
		\pgfmathparse{0.75*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
		\pgfmathparse{\pgf@x-\leadlen}
		\pgf@x=\pgfmathresult pt
	}

	\anchor{sel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{fwd}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=-\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{out}{
		\northwest
		\pgf@y=0pt
		\pgfmathparse{-\pgf@x + \leadlen}
		\pgf@x=\pgfmathresult pt
	}

	%
	% b anchors
	%

	\anchor{bin0}{
		\northwest
		\pgfmathparse{0.75*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{bin1}{
		\northwest
		\pgfmathparse{0.25*(\pgf@y + \cutinheight)}
		\pgf@y=\pgfmathresult pt
	}

	\anchor{bin2}{
		\northwest
		\pgfmathparse{0.25*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult pt
	}

	\anchor{bin3}{
		\northwest
		\pgfmathparse{0.75*(\pgf@y + \cutinheight)}
		\pgf@y=-\pgfmathresult ptt
	}

	\anchor{bsel}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{bfwd}{
		\northwest
		\pgfmathparse{\pgf@y + 0.5*\cutinheight}
		\pgf@y=-\pgfmathresult pt
		\pgf@x=0 pt
	}

	\anchor{bout}{
		\northwest
		\pgf@y=0pt
		\pgf@x=-\pgf@x
	}

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% set up vars
		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% draw shape
		\pgfscope
		\pgf@circ@setlinewidth{processor}{\pgflinewidth}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down - \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up + \cutinheight}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\ifpgfcirc@draw@input@leads
			%input leads
			% in0
			\pgfmathparse{0.25*(\pgf@circ@res@up + \cutinheight)}
			\pgf@circ@res@step=\pgfmathresult pt
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{3\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{3\pgf@circ@res@step}}

			% in1
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@step}}

			% in2
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-\pgf@circ@res@step}}

			% in3
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{-3\pgf@circ@res@step}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{-3\pgf@circ@res@step}}
		\fi


		\ifpgfcirc@draw@output@leads
			%output leads
			% out
			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}
		\fi
		\pgfusepath{draw}

		%draw text
		\pgf@circ@text@strokecolor
		\pgftext[center,x=0pt,y=0.75\pgf@circ@res@up]{\customfont 00}
		\pgftext[center,x=0pt,y=0.25\pgf@circ@res@up]{\customfont 01}
		\pgftext[center,x=0pt,y=0.25\pgf@circ@res@down]{\customfont 10}
		\pgftext[center,x=0pt,y=0.75\pgf@circ@res@down]{\customfont 11}
	}
}

\long\def\pgfcirc@declare@ctrlunit#1#2{% #1 name, #2 sc (0) vs mc (1) vs pl (2)
	\pgfdeclareshape{#1}{
		%
		% setup
		%

		\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
		\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

		% define northwest as scaled endpoint
		\savedanchor\northwest{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@y=\ctikzvalof{\ctikzclass/control/heightsc}\pgf@circ@scaled@Rlen
			\pgf@y=.5\pgf@y % take half height
			\pgf@x=-\ctikzvalof{\ctikzclass/control/width}\pgf@circ@scaled@Rlen
			\pgf@x=.5\pgf@x % take half width
		}

		\saveddimen\leadlen
		{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
		}

		\saveddimen\radius
		{
			\pgf@x=\ctikzvalof{\ctikzclass/control/radius} pt
		}

		\saveddimen\clkwidth
		{
			\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
			\pgf@x=\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
		}

		\saveddimen\realheight
		{
			\ifnum#2=1
				\pgf@x=\ctikzvalof{\ctikzclass/control/heightmc}\pgf@circ@scaled@Rlen
			\else
				\pgf@x=\ctikzvalof{\ctikzclass/control/heightsc}\pgf@circ@scaled@Rlen
			\fi
			\pgf@x=0.5\pgf@x
		}

		%
		% anchors
		%

		\defineorientationanchors

		\anchor{text}{
			\pgf@x=-.5\wd\pgfnodeparttextbox
			\ifnum#2=0
				\pgfmathparse{0.5*\realheight-0.5\ht\pgfnodeparttextbox}
			\else
				\pgfmathparse{0.75*\realheight-0.5\ht\pgfnodeparttextbox}
			\fi
			\pgf@y=\pgfmathresult pt
		}

		%
		% pin anchors
		%

		\anchor{op}{
			\northwest
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
			\pgf@y=0pt
		}
		\anchor{funct3}{
			\northwest
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
			\pgf@y=-0.25\pgf@y
		}
		\anchor{funct7}{
			\northwest
			\pgfmathparse{\pgf@x-\leadlen}
			\pgf@x=\pgfmathresult pt
			\pgf@y=-0.5\pgf@y
		}
		\anchor{zero}{
			\ifnum#2<2
				\northwest
				\pgfmathparse{\pgf@x-\leadlen}
				\pgf@x=\pgfmathresult pt
				\pgf@y=-0.75\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{clk}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{2*\realheight-\pgf@y}
				\pgf@y=\pgfmathresult pt
				\pgf@x=0pt
			\else
				\pgfpointorigin
			\fi
		}


		\anchor{pcsrc}{
			\ifnum#2=0
				\northwest
				\pgfmathparse{-\pgf@x+\leadlen}
				\pgf@x=\pgfmathresult pt
				\pgf@y=0.75\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{resultsrc}{
			\northwest
			\pgfmathparse{-\pgf@x+\leadlen}
			\pgf@x=\pgfmathresult pt
			\ifnum#2<2
				\pgf@y=0.5\pgf@y
			\else
				\pgf@y=0.625\pgf@y
			\fi
		}
		\anchor{memwrite}{
			\northwest
			\pgfmathparse{-\pgf@x+\leadlen}
			\pgf@x=\pgfmathresult pt
			\ifnum#2=0
				\pgf@y=0.25\pgf@y
			\else
				\ifnum#2=1
					\pgf@x=-\pgfmathresult pt
					\pgf@y=0.75\pgf@y
				\else
					\pgf@y=0.375\pgf@y
				\fi
			\fi
		}
		\anchor{alucontrol}{
			\northwest
			\pgfmathparse{-\pgf@x+\leadlen}
			\pgf@x=\pgfmathresult pt
			\ifnum#2=0
				\pgf@y=0 pt
			\else
				\ifnum#2=1
					\pgf@y=0.25\pgf@y
				\else
					\pgf@y=-0.375\pgf@y
				\fi
			\fi
		}
		\anchor{alusrc}{
			\northwest
			\pgfmathparse{-\pgf@x+\leadlen}
			\pgf@x=\pgfmathresult pt
			\ifnum#2=0
				\pgf@y=-0.25\pgf@y
			\else
				\ifnum#2=1
					\pgfpointorigin
				\else
					\pgf@y=-0.625\pgf@y
				\fi
			\fi
		}
		\anchor{alusrca}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{-\pgf@x+\leadlen}
				\pgf@x=\pgfmathresult pt
				\pgf@y=-0.25\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{alusrcb}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{-\pgf@x+\leadlen}
				\pgf@x=\pgfmathresult pt
				\pgf@y=0 pt
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{immsrc}{
			\northwest
			\pgfmathparse{-\pgf@x+\leadlen}
			\pgf@x=\pgfmathresult pt
			\ifnum#2<2
				\pgf@y=-0.5\pgf@y
			\else
				\pgf@y=-0.875\pgf@y
			\fi
		}
		\anchor{regwrite}{
			\northwest
			\pgfmathparse{-\pgf@x+\leadlen}
			\pgf@x=\pgfmathresult pt
			\ifnum#2<2
				\pgf@y=-0.75\pgf@y
			\else
				\pgf@y=0.875\pgf@y
			\fi
		}
		\anchor{irwrite}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{\pgf@x-\leadlen}
				\pgf@x=\pgfmathresult pt
				\pgf@y=0.5\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{adrsrc}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{\pgf@x-\leadlen}
				\pgf@x=\pgfmathresult pt
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{pcwrite}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{\pgf@x-\leadlen}
				\pgf@x=\pgfmathresult pt
				\pgf@y=1.25\pgf@y
			\else
				\pgfpointorigin
			\fi
		}

		\anchor{branch}{
			\ifnum#2=2
				\northwest
				\pgfmathparse{\pgf@x-\leadlen}
				\pgf@x=-\pgfmathresult pt
				\pgf@y=-0.125\pgf@y
			\else
				\pgfpointorigin
			\fi
		}

		\anchor{jump}{
			\ifnum#2=2
				\northwest
				\pgfmathparse{\pgf@x-\leadlen}
				\pgf@x=-\pgfmathresult pt
				\pgf@y=0.125\pgf@y
			\else
				\pgfpointorigin
			\fi
		}

		%
		% b anchors
		%

		\anchor{bop}{
			\northwest
			\pgf@y=0pt
		}
		\anchor{bfunct3}{
			\northwest
			\pgf@y=-0.25\pgf@y
		}
		\anchor{bfunct7}{
			\northwest
			\pgf@y=-0.5\pgf@y
		}
		\anchor{bzero}{
			\ifnum#2<2
				\northwest
				\pgf@y=-0.75\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{bclk}{
			\ifnum#2=1
				\northwest
				\pgfmathparse{2*\realheight-\pgf@y}
				\pgf@y=\pgfmathresult pt
				\pgf@x=0pt
			\else
				\pgfpointorigin
			\fi
		}


		\anchor{bpcsrc}{
			\ifnum#2=0
				\northwest
				\pgf@x=-\pgf@x
				\pgf@y=0.75\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{bresultsrc}{
			\northwest
			\pgf@x=-\pgf@x
			\ifnum#2<2
				\pgf@y=0.5\pgf@y
			\else
				\pgf@y=0.625\pgf@y
			\fi
		}
		\anchor{bmemwrite}{
			\northwest
			\pgf@x=-\pgf@x
			\ifnum#2=0
				\pgf@y=0.25\pgf@y
			\else
				\ifnum#2=1
					\pgf@x=-\pgf@x
					\pgf@y=0.75\pgf@y
				\else
					\pgf@y=0.375\pgf@y
				\fi
			\fi
		}
		\anchor{balucontrol}{
			\northwest
			\pgf@x=-\pgf@x
			\ifnum#2=0
				\pgf@y=0 pt
			\else
				\ifnum#2=1
					\pgf@y=0.25\pgf@y
				\else
					\pgf@y=-0.375\pgf@y
				\fi
			\fi
		}
		\anchor{balusrc}{
			\northwest
			\pgf@x=-\pgf@x
			\ifnum#2=0
				\pgf@y=-0.25\pgf@y
			\else
				\ifnum#2=1
					\pgfpointorigin
				\else
					\pgf@y=-0.625\pgf@y
				\fi
			\fi
		}
		\anchor{balusrca}{
			\ifnum#2=1
				\northwest
				\pgf@x=-\pgf@x
				\pgf@y=-0.25\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{balusrcb}{
			\ifnum#2=1
				\northwest
				\pgf@x=-\pgf@x
				\pgf@y=0 pt
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{bimmsrc}{
			\northwest
			\pgf@x=-\pgf@x
			\ifnum#2<2
				\pgf@y=-0.5\pgf@y
			\else
				\pgf@y=-0.875\pgf@y
			\fi
		}
		\anchor{bregwrite}{
			\northwest
			\pgf@x=-\pgf@x
			\ifnum#2<2
				\pgf@y=-0.75\pgf@y
			\else
				\pgf@y=0.875\pgf@y
			\fi
		}
		\anchor{birwrite}{
			\ifnum#2=1
				\northwest
				\pgf@y=0.5\pgf@y
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{badrsrc}{
			\ifnum#2=1
				\northwest
			\else
				\pgfpointorigin
			\fi
		}
		\anchor{bpcwrite}{
			\ifnum#2=1
				\northwest
				\pgf@y=1.25\pgf@y
			\else
				\pgfpointorigin
			\fi
		}

		\anchor{bbranch}{
			\ifnum#2=2
				\northwest
				\pgf@x=-\pgf@x
				\pgf@y=-0.125\pgf@y
			\else
				\pgfpointorigin
			\fi
		}

		\anchor{bjump}{
			\ifnum#2=2
				\northwest
				\pgf@x=-\pgf@x
				\pgf@y=0.125\pgf@y
			\else
				\pgfpointorigin
			\fi
		}

		%
		% outline
		%

		\pgf@circ@draw@component{
			\pgf@circ@scaled@Rlen=\scaledRlen
			\pgf@circ@setcolor

			% draw shape
			\pgfscope
			\northwest
			\pgfmathparse{\realheight-\pgf@y}
			\pgftransformyshift{\pgfmathresult pt}
			% set up vars for real height
			\northwest
			\pgf@circ@res@up = \realheight
			\pgf@circ@res@down = -\realheight
			\pgf@circ@res@right = -\pgf@x
			\pgf@circ@res@left = \pgf@x


			\pgf@circ@setlinewidth{processor}{\pgflinewidth}
			\pgfsetcornersarced{\pgfpoint{\radius}{\radius}}

			\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
			\pgfpathclose

			\pgf@circ@draworfill

			\pgfsetcornersarced{\pgfpoint{0pt}{0pt}}
			\ifnum#2=1
				\ifpgfcirc@draw@clock
					% draw CLK input
					\pgfmathparse{0.5*\clkwidth}
					\pgf@circ@res@step = \pgfmathresult pt
					\pgfpathmoveto{\pgfpoint{-\pgf@circ@res@step}{\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{0pt}{\pgf@circ@res@up - \pgf@circ@res@step}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@step}{\pgf@circ@res@up}}
					\pgfpathclose
				\fi
			\fi

			\endpgfscope

			% set up vars for small height
			\northwest
			\pgf@circ@res@up = \pgf@y
			\pgf@circ@res@down = -\pgf@y
			\pgf@circ@res@right = -\pgf@x
			\pgf@circ@res@left = \pgf@x

			\ifpgfcirc@draw@input@leads
				%input leads	
				% op
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left - \leadlen}{0pt}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0pt}}
				% funct3
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.25\pgf@circ@res@down}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.25\pgf@circ@res@down}}
				% funct7
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@down}}
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@down}}

				\ifnum#2<2
					% zero
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.75\pgf@circ@res@down}}
				\fi
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.75\pgf@circ@res@down}}
			\fi

			\ifpgfcirc@draw@output@leads
				%output leads
				% pcsrc
				\ifnum#2=0
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.75\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.75\pgf@circ@res@up}}
				\fi

				\ifnum#2<2
					% resultsrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.5\pgf@circ@res@up}}
					% memwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.25\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.25\pgf@circ@res@up}}
					% alucontrol
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0pt}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0pt}}
					% alusrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.25\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.25\pgf@circ@res@down}}
					% immsrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.5\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.5\pgf@circ@res@down}}
					% regwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.75\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.75\pgf@circ@res@down}}
				\fi

				\ifnum#2=1
					% irwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.5\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.5\pgf@circ@res@up}}
					% memwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{0.75\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{0.75\pgf@circ@res@up}}
					% adrsrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
					% pcwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left-\leadlen}{1.25\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{1.25\pgf@circ@res@up}}
				\fi

				\ifnum#2=2
					% regwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.875\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.875\pgf@circ@res@up}}
					% resultsrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.625\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.625\pgf@circ@res@up}}
					% memwrite
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.375\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.375\pgf@circ@res@up}}
					% jump
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.125\pgf@circ@res@up}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.125\pgf@circ@res@up}}
					% branch
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.125\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.125\pgf@circ@res@down}}
					% alucontrol
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.375\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.375\pgf@circ@res@down}}
					% alusrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.625\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.625\pgf@circ@res@down}}
					% immsrc
					\pgfpathmoveto{\pgfpoint{\pgf@circ@res@right+\leadlen}{0.875\pgf@circ@res@down}}
					\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{0.875\pgf@circ@res@down}}
				\fi
			\fi
			\pgfusepath{draw}

			%draw text
			\pgf@circ@text@strokecolor
			\pgftext[left,x=0.9\pgf@circ@res@left,y=0pt]{\customfont op}
			\pgftext[left,x=0.9\pgf@circ@res@left,y=0.25\pgf@circ@res@down]{\customfont funct3}
			\pgftext[left,x=0.9\pgf@circ@res@left,y=0.5\pgf@circ@res@down]{\customfont funct7\textsubscript{5}}

			\ifnum#2<2
				\pgftext[left,x=0.9\pgf@circ@res@left,y=0.75\pgf@circ@res@down]{\customfont zero}
			\fi
		}
	}
}

\pgfcirc@declare@ctrlunit{ctrlunitsc}{0}
\pgfcirc@declare@ctrlunit{ctrlunitmc}{1}
\pgfcirc@declare@ctrlunit{ctrlunitpl}{2}

\pgfdeclareshape{hazunit}{
	%
	% setup
	%

	\savedmacro{\ctikzclass}{\edef\ctikzclass{processor}}
	\saveddimen{\scaledRlen}{\pgfmathsetlength{\pgf@x}{\ctikzvalof{\ctikzclass/scale}\pgf@circ@Rlen}}

	% define northwest as scaled endpoint
	\savedanchor\northwest{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@y=\ctikzvalof{\ctikzclass/hazard/height}\pgf@circ@scaled@Rlen
		\pgf@y=.5\pgf@y % take half height
		\pgf@x=-\ctikzvalof{\ctikzclass/hazard/width}\pgf@circ@scaled@Rlen
		\pgf@x=.5\pgf@x % take half width
	}

	\saveddimen\leadlen
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/leadlen}\pgf@circ@scaled@Rlen
	}

	\saveddimen\radius
	{
		\pgf@x=\ctikzvalof{\ctikzclass/hazard/radius} pt
	}

	\saveddimen\clkwidth
	{
		\pgfmathsetlength{\pgf@circ@scaled@Rlen}{\ctikzvalof{\ctikzclass/scale}*\pgf@circ@Rlen}
		\pgf@x=\ctikzvalof{\ctikzclass/misc/smallwidth}\pgf@circ@scaled@Rlen
	}

	%
	% anchors
	%

	\defineorientationanchors

	\anchor{text}{
		\pgf@x=-.5\wd\pgfnodeparttextbox
		\pgf@y=-.5\ht\pgfnodeparttextbox
	}

	%
	% pin anchors
	%

	% no pin anchors as connections should be aligned with drawing

	%
	% b anchors
	%

	% no b anchors as connections should be aligned with drawing

	%
	% outline
	%

	\pgf@circ@draw@component{
		\pgf@circ@scaled@Rlen=\scaledRlen
		\pgf@circ@setcolor

		% draw shape
		\pgfscope
		\northwest

		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x


		\pgf@circ@setlinewidth{processor}{\pgflinewidth}
		\pgfsetcornersarced{\pgfpoint{\radius}{\radius}}

		\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@down}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@left}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@up}}
		\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{\pgf@circ@res@down}}
		\pgfpathclose

		\pgf@circ@draworfill
		\endpgfscope

		\northwest
		\pgf@circ@res@up = \pgf@y
		\pgf@circ@res@down = -\pgf@y
		\pgf@circ@res@right = -\pgf@x
		\pgf@circ@res@left = \pgf@x

		% no leads to draw

		% no text to draw
	}
}


\makeatother

\endinput
