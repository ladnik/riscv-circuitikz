\documentclass[.52pt,a4paper,titlepage]{article}

\usepackage{a4wide}
\usepackage[T1]{fontenc}
\usepackage{tikz}
\usepackage{circuitikz}
\usetikzlibrary{calc, riscvproc, positioning, fit, decorations, decorations.pathmorphing}
\usepackage{ctikzmanutils}
\usepackage{ifthen}
\usepackage{xparse}
\usepackage{showexpl}
\usepackage{ragged2e}
\usepackage{pdflscape}
\usepackage{fancyhdr} 
\usepackage{pgfkeys}
\usepackage[dvipsnames]{xcolor}

\parindent=0pt
\parskip=4pt plus 6pt minus 2pt

% https://tex.stackexchange.com/a/453038
\fancypagestyle{mylandscape}{
	\fancyhf{} %Clears the header/footer
	\fancyfoot{% Footer
		\makebox[\textwidth][r]{% Right
			\rlap{\hspace{.75cm}% Push out of margin by \footskip
				\smash{% Remove vertical height
					\raisebox{4.87in}{% Raise vertically
						\rotatebox{90}{\thepage}}}}}}% Rotate counter-clockwise
	\renewcommand{\headrulewidth}{0pt}% No header rule
	\renewcommand{\footrulewidth}{0pt}% No footer rule
}

%
% modified gelrcoord: https://github.com/circuitikz/circuitikz/blob/master/doc/ctikzmanutils.sty
%
\newcommand{\modgeolrcoord}[2][]{\showanchors[#1]{#2}{text}(north/90/0.4, north east/45/0.4, east/0/0.4,
	south east/-45/0.4,
	south/-90/0.4, south west/-.535/0.4, west/.580/0.4, north west/.535/0.4,
	left/.560/0.4, right/30/0.4, center/-.520/0.3
	)
}
\newcommand\defaultanchors{
}

\definecolor{modblue}{HTML}{288DCC}

\title{RISC-V Processor \Circuitikz{} Library}
\author{Niklas Ladurner}
\date{\today}

\begin{document}

\begin{center}
	\LARGE \textbf{\thetitle}

	\normalsize \thedate
\end{center}

%\circuitdesc*{instrmem}{Instruction Memory}{}()
%\modgeolrcoord{instrmem}
%\showanchors{instrmem, align=center}{Instruction\\Memory}(
%a/.580/0.4,
%rd/0/0.4
%)

\section{Components}

\subsection{Instruction Memory}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}
			\node[instrmem, align=center] (comp) {Instruction\\Memory};

			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, blue] (comp.rd) -- ++(.5, 0) node[right] {rd};
		\end{circuitikz}
	\end{LTXexample}
\end{center}



\subsection{Data Memory}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[datamem, align=center] (comp) {Data\\Memory};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.wd) -- ++(-.5, 0) node[left] {wd};
			\draw[->, red] (comp.clk) -- ++(0, .5) node[above] {clk};
			\draw[->, red] (comp.we) -- ++(0, .5) node[above] {we};
			\draw[->, blue] (comp.rd) -- ++(.5, 0) node[right] {rd};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Register File}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[regfile, align=center] (comp) {Register\\File};
			\draw[->, red] (comp.a1) -- ++(-.5, 0) node[left] {a1};
			\draw[->, red] (comp.a2) -- ++(-.5, 0) node[left] {a2};
			\draw[->, red] (comp.a3) -- ++(-.5, 0) node[left] {a3};
			\draw[->, red] (comp.wd3) -- ++(-.5, 0) node[left] {wd3};

			\draw[->, red] (comp.clk) -- ++(0, .5) node[above] {clk};
			\draw[->, red] (comp.we3) -- ++(0, .5) node[above] {we3};
			\draw[->, blue] (comp.rd1) -- ++(.5, 0) node[right] {rd1};
			\draw[->, blue] (comp.rd2) -- ++(.5, 0) node[right] {rd2};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Extend Unit}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[extend, align=center] (comp) {Extend};
			\draw[->, red] (comp.in) -- ++(-.5, 0) node[left] {in};
			\draw[->, red] (comp.ctrl) -- ++(0, .5) node[above] {ctrl};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Arithmetic Logic Unit}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[alu, align=center] (comp) {ALU};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.b) -- ++(-.5, 0) node[left] {b};
			\draw[->, red] (comp.ctrl) -- ++(0, .5) node[above] {ctrl};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
			\draw[->, blue] (comp.zero) -- ++(.5, 0) node[right] {zero};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Register}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[reg, align=center] (comp) {};
			\draw[->, red] (comp.in) -- ++(-.5, 0) node[left] {in};
			\draw[->, red] (comp.clk) -- ++(0, .5) node[above] {clk};
			%\draw[->, red] (comp.en) -- ++(0, -.5) node[below] {en};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Adder}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[adder, align=center] (comp) {};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.b) -- ++(-.5, 0) node[left] {b};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Subtractor}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[sub, align=center] (comp) {};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.b) -- ++(-.5, 0) node[left] {b};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Multiplexer}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[mux, align=center] (comp) {};
			\draw[->, red] (comp.in0) -- ++(-.5, 0) node[left] {in0};
			\draw[->, red] (comp.in1) -- ++(-.5, 0) node[left] {in1};
			\draw[->, red] (comp.sel) -- ++(0, .5) node[above] {sel};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Single-Cycle Control Unit}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[ctrlunitsc, align=center] (comp) {Control\\Unit};
			\draw[->, red] (comp.op) -- ++(-.5, 0) node[left] {op};
			\draw[->, red] (comp.funct3) -- ++(-.5, 0) node[left] {funct3};
			\draw[->, red] (comp.funct7) -- ++(-.5, 0) node[left] {funct7};
			\draw[->, red] (comp.zero) -- ++(-.5, 0) node[left] {zero};

			\draw[->, blue] (comp.pcsrc) -- ++(.5, 0) node[right] {pcsrc};
			\draw[->, blue] (comp.resultsrc) -- ++(.5, 0) node[right] {resultsrc};
			\draw[->, blue] (comp.memwrite) -- ++(.5, 0) node[right] {memwrite};
			\draw[->, blue] (comp.alucontrol) -- ++(.5, 0) node[right] {alucontrol};
			\draw[->, blue] (comp.alusrc) -- ++(.5, 0) node[right] {alusrc};
			\draw[->, blue] (comp.immsrc) -- ++(.5, 0) node[right] {immsrc};
			\draw[->, blue] (comp.regwrite) -- ++(.5, 0) node[right] {regwrite};
		\end{circuitikz}
	\end{LTXexample}
\end{center}


\begin{landscape}
	\thispagestyle{mylandscape}
	\section{Single-Cycle RISC-V Processor}
	\begin{center}
		\begin{circuitikz}
			\tikzset{
				label/.style={draw=none, inner sep=1pt, font=\small},
				comp/.style={align=center, no leads},
				custyle/.style={color=modblue},
			}

			% components
			\node[regfile, comp] (rf) {Register\\File};
			\node[instrmem, comp, left=2cm of rf] (im) {Instruction\\Memory};
			\node[alu,comp, right=2.25cm of rf.rd1, anchor=a] (alu) {ALU};
			\node[datamem,comp, right=6.25cm of rf] (dm) {Data\\Memory};

			\node[ctrlunitsc, comp, custyle, above=1cm of rf, xshift=-0.75cm] (cu) {Control\\Unit};

			\node[extend, comp, below=1cm of rf] (ext) {Extend};
			\node[adder, comp, anchor=b] (addpctarget) at (ext.out -| alu.a) {};
			\node[adder, comp, anchor=a] (addpcplus4) at (ext.in -| im.a) {};

			% TODO: aling mux.out and alu.b
			\node[mux, comp, right=0.9cm of rf.rd2, anchor=in0] (muxalusrc) {};
			\node[reg, comp, left=0.3cm of im.a] (regpcnext) {};
			\node[mux, comp, left=1.25cm of regpcnext] (muxpcnext) {};
			\node[mux, comp, right=1cm of dm.rd, anchor=in1] (muxresult) {};

			% special nodes
			% clks
			\node[align=center, label, above=0.25cm of regpcnext.clk] (clk1) {CLK};
			\draw[] (clk1) -- (regpcnext.clk);
			\node[align=center, label, above=0.25cm of rf.bclk] (clkrf) {CLK};
			\draw[] (clkrf) -- (rf.bclk);
			\node[align=center, label, above=0.25cm of dm.bclk] (clkdm) {CLK};
			\draw[] (clkdm) -- (dm.bclk);

			% constants
			\node[align=right, label, left=0.25cm of addpcplus4.bb] (const4) {4};
			\draw[] (const4) -- (addpcplus4.bb);

			% connections
			% register file
			\draw[] (rf.brd1) -- (alu.ba);
			\draw[] (rf.brd2) -- (muxalusrc.bin0);
			\draw[] (rf.brd2) -- ++(1, 0) |- (dm.bwd);

			% alu
			\draw[] (muxalusrc.bout) |- (alu.bb);
			\draw[] (alu.bout) -| (dm.ba);
			\draw[] (alu.bzero) -- ++(1, 0) -- ++(0, 1.5)-- ++(-8,0)  |- (cu.bzero) ;

			% data memory
			\draw[] (dm.brd) -- (muxresult.bin1);
			\draw[] (alu.bout) -- ++(2,0) -- ++(0, 2) -- ++(3.5,0) |- (muxresult.bin0);
			\draw[] (muxresult.bout) -- ++(0.25,0) -- ++(0,-5) -- ++(-14.3, 0) node[align=center,above,pos=0.05] {Result} |- (rf.bwd3);

			% extend unit
			\draw[] (ext.bout) -- (addpctarget.bb);
			\draw[] (ext.bout) ++(1.5, 0)|- (muxalusrc.bin1);

			% instruction memory
			\draw[] (im.brd) -- ++(1.15, 0) |- (cu.bop);
			\draw[] (im.brd) -- ++(1.15, 0) |- (cu.bfunct3);
			\draw[] (im.brd) -- ++(1.15, 0) |- (cu.bfunct7);
			\draw[] (im.brd) -- ++(1.15, 0) |- (rf.ba1);
			\draw[] (im.brd) -- ++(1.15, 0) |- (rf.ba2);
			\draw[] (im.brd) -- ++(1.15, 0) |- (rf.ba3);
			\draw[] (im.brd) -- ++(1.15, 0) |- (ext.bin);
			\draw[] (regpcnext.bout) -- (im.ba);
			
			% control unit
			\draw[custyle] (cu.bregwrite) -| (rf.bwe3);
			\draw[custyle] (cu.bimmsrc) -- ++(2, 0) -- ++(0, -5.5) -| (ext.bctrl);
			\draw[custyle] (cu.balusrc) -| (muxalusrc.bsel);
			\draw[custyle] (cu.balucontrol) -| (alu.bctrl);
			\draw[custyle] (cu.bmemwrite) -| (dm.bwe);
			\draw[custyle] (cu.bresultsrc) -| (muxresult.bsel);
			\draw[custyle] (cu.bpcsrc) -- ++(1.25, 0) -- ++(0, 0.75)-| (muxpcnext.bsel);

			% additional connections
			\draw[] (addpcplus4.bout) -- ++(0.25,0) -- ++(0, -1.25)  -- ++ (-4.5,0) |- (muxpcnext.bin0);
			\draw[] (regpcnext.bout) -- ++(0.3, 0) |- (addpcplus4.ba);
			\draw[] (regpcnext.bout) -- ++(0.3, 0) |- (addpctarget.ba);
			\draw[] (addpctarget.bout) -- ++(0.25, 0) -- ++(0, -2.75) -- ++ (-14.5,0) |- (muxpcnext.bin1);
			\draw[] (muxpcnext.bout) -- (regpcnext.bin) node[align=center, label, above, pos=0.5] {PCNext};

			% labels
			\node[align=right, label, left=0.25em of alu.ba, yshift=0.5em] {SrcA};
			\node[align=right, label, left=0.25em of alu.bb, yshift=0.5em] {SrcB};
			\node[align=left, label, right=0.25em of alu.bout, yshift=0.5em] {ALUResult};
			\node[align=left, label, right=0.25em of alu.bzero, yshift=0.5em] {Zero};
			\node[align=left, label, right=0.25em of dm.brd, yshift=0.5em] {ReadData};
			\node[align=left, label, right=0.25em of alu.bout, yshift=-1.15cm+0.5em] {WriteData};
			\node[align=left, label, right=0.25em of ext.bout, yshift=0.5em] {ImmExt};
			\node[align=right, label, left=0.25em of cu.bop, yshift=0.5em] {\scriptsize{6:0}};
			\node[align=right, label, left=0.25em of cu.bfunct3, yshift=0.5em] {\scriptsize{14:12}};
			\node[align=right, label, left=0.25em of cu.bfunct7, yshift=0.5em] {\scriptsize{30}};
			\node[align=right, label, left=0.25em of rf.ba1, yshift=0.5em] {\scriptsize{19:15}};
			\node[align=right, label, left=0.25em of rf.ba2, yshift=0.5em] {\scriptsize{24:20}};
			\node[align=right, label, left=0.25em of rf.ba3, yshift=0.5em] {\scriptsize{11:7}};
			\node[align=right, label, left=0.25em of ext.bin, yshift=0.5em] {\scriptsize{31:7}};
			\node[align=left, label, custyle, right=0.25em of cu.bregwrite, yshift=0.5em] {RegWrite};
			\node[align=left, label, custyle, right=0.25em of cu.bimmsrc, yshift=0.5em] {ImmSrc\textsubscript{1:0}};
			\node[align=left, label, custyle, right=0.25em of cu.balusrc, yshift=0.5em] {ALUSrc};
			\node[align=left, label, custyle, right=0.25em of cu.balucontrol, yshift=0.5em] {ALUControl\textsubscript{2:0}};
			\node[align=left, label, custyle, right=0.25em of cu.bmemwrite, yshift=0.5em] {MemWrite};
			\node[align=left, label, custyle, right=0.25em of cu.bresultsrc, yshift=0.5em] {ResultSrc};
			\node[align=left, label, custyle, right=0.25em of cu.bpcsrc, yshift=0.5em] {PCSrc};
			\node[align=left, label, right=0.25em of addpcplus4.bout, yshift=0.5em] {PCPlus4};
			\node[align=left, label, right=0.25em of addpctarget.bout, yshift=0.5em] {PCTarget};
			\node[align=left, label, right=0.25em of im.brd, yshift=0.5em] {Instr};	
		\end{circuitikz}
	\end{center}

\end{landscape}
\end{document}

\end{document}

