\documentclass[.52pt,a4paper,titlepage]{article}

\usepackage{a4wide}
\usepackage[T1]{fontenc}
\usepackage{tikz}
\usepackage{circuitikz}
\usetikzlibrary{calc, riscvproc, positioning, fit, decorations, decorations.pathmorphing}
\usepackage{ctikzmanutils}
\usepackage{ifthen}
\usepackage{xparse}
\usepackage{showexpl}
\usepackage{ragged2e}
\usepackage{pdflscape}
\usepackage{fancyhdr} 
\usepackage{pgfkeys}

\parindent=0pt
\parskip=4pt plus 6pt minus 2pt

% https://tex.stackexchange.com/a/453038
\fancypagestyle{mylandscape}{
	\fancyhf{} %Clears the header/footer
	\fancyfoot{% Footer
		\makebox[\textwidth][r]{% Right
			\rlap{\hspace{.75cm}% Push out of margin by \footskip
				\smash{% Remove vertical height
					\raisebox{4.87in}{% Raise vertically
						\rotatebox{90}{\thepage}}}}}}% Rotate counter-clockwise
	\renewcommand{\headrulewidth}{0pt}% No header rule
	\renewcommand{\footrulewidth}{0pt}% No footer rule
}

%
% modified gelrcoord: https://github.com/circuitikz/circuitikz/blob/master/doc/ctikzmanutils.sty
%
\newcommand{\modgeolrcoord}[2][]{\showanchors[#1]{#2}{text}(north/90/0.4, north east/45/0.4, east/0/0.4,
	south east/-45/0.4,
	south/-90/0.4, south west/-.535/0.4, west/.580/0.4, north west/.535/0.4,
	left/.560/0.4, right/30/0.4, center/-.520/0.3
	)
}
\newcommand\defaultanchors{
}

\title{RISC-V Processor \Circuitikz{} Library}
\date{\today}

\begin{document}

\begin{center}
	\LARGE \textbf{\thetitle}

	\normalsize \thedate
\end{center}

%\circuitdesc*{instrmem}{Instruction Memory}{}()
%\modgeolrcoord{instrmem}
%\showanchors{instrmem, align=center}{Instruction\\Memory}(
%a/.580/0.4,
%rd/0/0.4
%)

\section{Components}

\subsection{Instruction Memory}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}
			\node[instrmem, align=center] (comp) {Instruction\\Memory};

			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, blue] (comp.rd) -- ++(.5, 0) node[right] {rd};
		\end{circuitikz}
	\end{LTXexample}
\end{center}



\subsection{Data Memory}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[datamem, align=center] (comp) {Data\\Memory};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.wd) -- ++(-.5, 0) node[left] {wd};
			\draw[->, red] (comp.clk) -- ++(0, .5) node[above] {clk};
			\draw[->, red] (comp.we) -- ++(0, .5) node[above] {we};
			\draw[->, blue] (comp.rd) -- ++(.5, 0) node[right] {rd};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Register File}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[regfile, align=center] (comp) {Register\\File};
			\draw[->, red] (comp.a1) -- ++(-.5, 0) node[left] {a1};
			\draw[->, red] (comp.a2) -- ++(-.5, 0) node[left] {a2};
			\draw[->, red] (comp.a3) -- ++(-.5, 0) node[left] {a3};
			\draw[->, red] (comp.wd3) -- ++(-.5, 0) node[left] {wd3};

			\draw[->, red] (comp.clk) -- ++(0, .5) node[above] {clk};
			\draw[->, red] (comp.we3) -- ++(0, .5) node[above] {we3};
			\draw[->, blue] (comp.rd1) -- ++(.5, 0) node[right] {rd1};
			\draw[->, blue] (comp.rd2) -- ++(.5, 0) node[right] {rd2};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Extend Unit}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[extend, align=center] (comp) {Extend};
			\draw[->, red] (comp.in) -- ++(-.5, 0) node[left] {in};
			\draw[->, red] (comp.ctrl) -- ++(0, .5) node[above] {ctrl};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Arithmetic Logic Unit}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[alu, align=center] (comp) {ALU};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.b) -- ++(-.5, 0) node[left] {b};
			\draw[->, red] (comp.ctrl) -- ++(0, .5) node[above] {ctrl};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
			\draw[->, blue] (comp.zero) -- ++(.5, 0) node[right] {zero};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Register}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[reg, align=center] (comp) {};
			\draw[->, red] (comp.in) -- ++(-.5, 0) node[left] {in};
			\draw[->, red] (comp.clk) -- ++(0, .5) node[above] {clk};
			%\draw[->, red] (comp.en) -- ++(0, -.5) node[below] {en};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Adder}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[adder, align=center] (comp) {};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.b) -- ++(-.5, 0) node[left] {b};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Subtractor}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[sub, align=center] (comp) {};
			\draw[->, red] (comp.a) -- ++(-.5, 0) node[left] {a};
			\draw[->, red] (comp.b) -- ++(-.5, 0) node[left] {b};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Multiplexer}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[mux, align=center] (comp) {};
			\draw[->, red] (comp.in0) -- ++(-.5, 0) node[left] {in0};
			\draw[->, red] (comp.in1) -- ++(-.5, 0) node[left] {in1};
			\draw[->, red] (comp.sel) -- ++(0, .5) node[above] {sel};
			\draw[->, blue] (comp.out) -- ++(.5, 0) node[right] {out};
		\end{circuitikz}
	\end{LTXexample}
\end{center}

\subsection{Single-Cycle Control Unit}
\begin{center}
	\begin{LTXexample}[varwidth, rframe=]
		\begin{circuitikz}[]
			\node[ctrlunitsc, align=center] (comp) {Control\\Unit};
			\draw[->, red] (comp.op) -- ++(-.5, 0) node[left] {op};
			\draw[->, red] (comp.funct3) -- ++(-.5, 0) node[left] {funct3};
			\draw[->, red] (comp.funct7) -- ++(-.5, 0) node[left] {funct7};
			\draw[->, red] (comp.zero) -- ++(-.5, 0) node[left] {zero};

			\draw[->, blue] (comp.pcsrc) -- ++(.5, 0) node[right] {pcsrc};
			\draw[->, blue] (comp.resultsrc) -- ++(.5, 0) node[right] {resultsrc};
			\draw[->, blue] (comp.memwrite) -- ++(.5, 0) node[right] {memwrite};
			\draw[->, blue] (comp.alucontrol) -- ++(.5, 0) node[right] {alucontrol};
			\draw[->, blue] (comp.alusrc) -- ++(.5, 0) node[right] {alusrc};
			\draw[->, blue] (comp.immsrc) -- ++(.5, 0) node[right] {immsrc};
			\draw[->, blue] (comp.regwrite) -- ++(.5, 0) node[right] {regwrite};
		\end{circuitikz}
	\end{LTXexample}
\end{center}


\begin{landscape}
	\thispagestyle{mylandscape}
%	\section{Single-Cycle RISC-V Processor}
%	\begin{center}
%		\resizebox{!}{0.75\textheight}{
%			\begin{circuitikz}
%				% components
%				\node[ctrlunitsc, align=center, blue] (cu) {Control\\Unit};
%				
%				\node[regfile, align=center, below=2cm of cu] (rf) {Register\\File};
%				\node[instrmem, align=center, left=3cm of rf] (im) {Instruction\\Memory};
%				\node[alu, align=center, right=2.5cm of rf.rd1, anchor=a] (alu) {ALU};
%				\node[datamem, align=center, right=8cm of rf] (dm) {Data\\Memory};
%				
%				\node[extend, align=center, below=1.5cm of rf] (ext) {Extend};
%				\node[adder, align=center, right=3cm of ext.out, anchor=a] (addpctarget) {};
%				\node[adder, align=center, left=5cm of ext.in, anchor=a] (addpcplus4) {};
%				
%				\node[mux, align=center, right=0.5cm of rf.rd2, anchor=in1] (muxalusrc) {};
%				\node[reg, align=center, left=1cm of im.a] (regpcnext) {};
%				\node[mux, align=center, left=1.5cm of regpcnext] (muxpcnext) {};
%				\node[mux, align=center, right=1.5cm of dm.rd, anchor=in2] (muxresult) {};
%				
%				% special nodes
%				\node[align=center, above=0.35cm of regpcnext.clk] (clk1) {CLK};
%				\draw[] (clk1) -- (regpcnext.clk);
%				\node[align=center, above=0cm of rf.clk] (clkrf) {CLK};
%				\node[align=center, above=0cm of dm.clk] (clkdm) {CLK};
%				\node[align=right, left=of addpcplus4.b] (const4) {4};
%				
%				%\node[draw] (btop) at ([shift=({1cm, 4cm})]im.rd){test};
%				
%				% connections
%				
%				% register file
%				\draw[blue] (cu.regwrite) -- ++(1, 0) node[align=left,above, pos=0.5] {RegWrite} |- (rf.we3);
%				\draw[] (rf.rd1) -- (alu.a) node[align=right,above, pos=0.95] {SrcA};
%				\draw[] (rf.rd2) -- (muxalusrc.in1);
%				
%				% alu
%				\draw[blue] (cu.alucontrol) -| (alu.ctrl) node[align=left,above, pos=0.1] {ALUControl\textsubscript{2:0}};
%				\draw[blue] (cu.alusrc) -| (muxalusrc.sel) node[align=left,above, pos=0.1] {ALUSrc};
%				\draw[] (muxalusrc.out) |- (alu.b) node[align=right,above, pos=0.9] {SrcB};
%				\draw[] (alu.out) -| (dm.a) node[align=left,above, pos=0.15] {ALUResult};
%				\draw[] (alu.zero) -- ++(0, 2.5) -- ++(-8,0) node[align=center,above,pos=0.25] {Zero} |- (cu.zero) ;
%				\draw[] (rf.rd2) |- (dm.wd);
%				
%				% data memory
%				\draw[blue] (cu.memwrite) -| (dm.we) node[align=left,above, pos=0.025] {MemWrite};
%				\draw[] (dm.rd) -- (muxresult.in2) node[align=center,above, pos=0.5] {ReadData};
%				\draw[] (alu.out) -- ++(2,0) -- ++(0, 2.5) -- ++(4.5,0) |- (muxresult.in1);
%				\draw[blue] (cu.resultsrc) -- ++(2, 0) node[align=left,above, pos=0.2] {ResultSrc} -| (muxresult.sel);
%				\draw[] (muxresult.out) -- ++(0,-4) -- ++(-18, 0) node[align=center,above,pos=0.05] {Result} |- (rf.wd3);
%				
%				% extend unit
%				\draw[blue] (cu.immsrc) -- ++(1.3, 0) node[align=left,above, pos=0.2] {ImmSrc} -- ++(0, -8) -| (ext.ctrl);
%				\draw[] (ext.out) -- (addpctarget.a) node[align=center,above, pos=0.5] {ImmExt};
%				\draw[] (ext.out) ++(0.25, 0)|- (muxalusrc.in2);
%				
%				% instruction memory
%				\draw[] (im.rd) -- ++(1, 0) |- (cu.op) node[align=right,above, pos=0.9] {\scriptsize{6:0}};
%				\draw[] (im.rd) -- ++(1, 0) |- (cu.funct3) node[align=right,above, pos=0.9] {\scriptsize{14:12}};
%				\draw[] (im.rd) -- ++(1, 0) |- (cu.funct7) node[align=right,above, pos=0.9] {\scriptsize{30}};
%				\draw[] (im.rd) -- ++(1, 0) |- (rf.a1) node[align=right,above, pos=0.9] {\scriptsize{19:15}};
%				\draw[] (im.rd) -- ++(1, 0) |- (rf.a2) node[align=right,above, pos=0.9] {\scriptsize{24:20}};
%				\draw[] (im.rd) -- ++(1, 0) |- (rf.a3) node[align=right,above, pos=0.9] {\scriptsize{11:7}};
%				\draw[] (im.rd) -- ++(1, 0) |- (ext.in) node[align=right,above, pos=0.9] {\scriptsize{31:7}};
%				
%				% pc updates
%				\draw[blue] (cu.pcsrc) -- ++(1, 0) node[align=left,above, pos=0.2] {PCSrc} -- ++ (0, 1)-| (muxpcnext.sel);
%				\draw[] (muxpcnext.out) -- (regpcnext.in) node[align=center,above, pos=0.5] {PCNext};
%				\draw[] (regpcnext.out) -- (im.a) node[align=center,above, pos=0.5] {PC};
%				\draw[] (regpcnext.out) |- (addpcplus4.a);
%				\draw[] (regpcnext.out |- addpcplus4.a) ++ (0, 1.5) -- ++(4, 0) |- (addpctarget.b);
%				\draw[] (const4) -- (addpcplus4.b);
%				\draw[] (addpcplus4.out) -- ++(0, -2)  -- ++ (-7,0)  node[align=center,above, pos=0.5] {PCPlus4} |- (muxpcnext.in1);
%				\draw[] (addpctarget.out) -- ++(0, -3)  -- ++ (-18.5,0)  node[align=center,above, pos=0.5] {PCTarget} |- (muxpcnext.in2);
%				
%			\end{circuitikz}
%	}
%	\end{center}

\end{landscape}
\geolrcoord{instrmem}
\end{document}

\end{document}

